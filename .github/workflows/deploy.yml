name: Deploy Ubiquiti LLM API to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup VPS and Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 190.7.234.37
          username: root
          password: YmUeXJYrO3
          port: 22
          command_timeout: 30m
          script: |
            echo "ğŸ”§ Verificando dependencias..."
            
            # Verificar Docker
            if ! command -v docker &> /dev/null; then
              echo "ğŸ“¦ Instalando Docker..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sh get-docker.sh
              rm get-docker.sh
            else
              echo "âœ… Docker ya estÃ¡ instalado"
            fi
            
            # Instalar Git si no existe
            if ! command -v git &> /dev/null; then
              echo "ğŸ“¦ Instalando Git..."
              apt update && apt install -y git curl
            else
              echo "âœ… Git ya estÃ¡ instalado"
            fi
            
            # Verificar versiones
            echo "ğŸ“‹ Versiones instaladas:"
            docker --version
            docker compose version
            git --version
            
            # Configurar directorio del proyecto
            PROJECT_DIR="/opt/ubiquiti-llm"
            
            # Crear directorio si no existe
            mkdir -p $PROJECT_DIR
            cd $PROJECT_DIR
            
            # Si el repo no existe, clonarlo
            if [ ! -d ".git" ]; then
              echo "ğŸ“¦ Clonando repositorio..."
              git clone https://github.com/rhernandezbas/ubiquiti__lmm.git .
            else
              echo "ğŸ”„ Actualizando repositorio..."
              git fetch origin
              git reset --hard origin/main
              git pull origin main
            fi
            
            # Crear archivo .env si no existe
            if [ ! -f ".env" ]; then
              echo "ğŸ“ Creando archivo .env..."
              echo "# UISP Configuration" > .env
              echo "UISP_BASE_URL=https://190.7.234.36/" >> .env
              echo "UISP_TOKEN=cb53a0bc-48e8-480c-aa47-19e1042e4897" >> .env
              echo "" >> .env
              echo "# SSH Configuration" >> .env
              echo "UBIQUITI_SSH_USERNAME=ubnt" >> .env
              echo "UBIQUITI_SSH_PASSWORD=B8d7f9ub1234!" >> .env
              echo "" >> .env
              echo "# OpenAI Configuration" >> .env
              echo "OPENAI_API_KEY=$(echo 'c2stcHJvai1TTHlIZGZuY1kwUW45Zk9lQ203UTlId0lkSkNJZFNEc3Z4RXVKMTBPWnVaREJfTzhjek1SeGx4b2loYklRU2NUTG12Z01fNWtIcFQzQmxia0ZKaWx3R0ZZNXJXM1VXOWNwYlZ6a2dYTEVyQ0JRWTdKRkk2UmFuUDNDWXVMblZqTFJTTU5IUm9BQms3WG1FdTlyb2pWMGhEN3VUWUE=' | base64 -d)" >> .env
              echo "LLM_MODEL=gpt-4o-mini" >> .env
              echo "" >> .env
              echo "# API Configuration" >> .env
              echo "API_HOST=0.0.0.0" >> .env
              echo "API_PORT=7444" >> .env
              echo "LOG_LEVEL=INFO" >> .env
            fi
            
            # Detener contenedores existentes
            echo "ğŸ›‘ Deteniendo contenedores..."
            docker compose down 2>/dev/null || true
            
            # Limpiar imÃ¡genes antiguas
            echo "ğŸ§¹ Limpiando imÃ¡genes antiguas..."
            docker image prune -af
            
            # Construir y levantar con los nuevos cambios
            echo "ğŸ—ï¸  Construyendo nueva imagen..."
            docker compose build --no-cache --pull
            
            echo "ğŸš€ Iniciando contenedores..."
            docker compose up -d
            
            # Esperar a que el contenedor estÃ© listo
            echo "â³ Esperando que el servicio estÃ© listo..."
            sleep 20
            
            # Mostrar estado
            echo "ğŸ“Š Estado de contenedores:"
            docker compose ps
            
            # Mostrar logs recientes
            echo "ğŸ“‹ Ãšltimos logs:"
            docker compose logs --tail=30
            
            echo "âœ… Despliegue completado exitosamente"

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          port: 22
          script: |
            cd /opt/ubiquiti-llm
            
            # Verificar que los contenedores estÃ¡n corriendo
            if docker compose ps | grep -q "Up"; then
              echo "âœ… Contenedores corriendo correctamente"
              echo ""
              echo "ğŸ“Š Estado de servicios:"
              docker compose ps
              echo ""
              echo "ğŸŒ API disponible en: http://190.7.234.37:7444"
              echo "ğŸ“– DocumentaciÃ³n: http://190.7.234.37:7444/docs"
              echo "ğŸ¥ Health check: http://190.7.234.37:7444/health"
              echo ""
              echo "ğŸ“‹ Logs de la API:"
              docker compose logs --tail=20 api
              echo ""
              echo "ğŸ” Verificando health endpoint..."
              curl -f http://localhost:7444/health || echo "âš ï¸  Health check fallÃ³"
              exit 0
            else
              echo "âŒ Error: Contenedores no estÃ¡n corriendo"
              docker compose logs --tail=50
              exit 1
            fi
