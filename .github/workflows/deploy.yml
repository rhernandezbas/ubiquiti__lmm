name: Deploy Ubiquiti LLM API to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: test
    permissions:
      contents: read
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug - Check if secrets are available
        run: |
          echo "Checking secrets availability (not showing values)..."
          [ -n "${{ secrets.UISP_BASE_URL }}" ] && echo "âœ… UISP_BASE_URL is set" || echo "âŒ UISP_BASE_URL is EMPTY"
          [ -n "${{ secrets.UISP_TOKEN }}" ] && echo "âœ… UISP_TOKEN is set" || echo "âŒ UISP_TOKEN is EMPTY"
          [ -n "${{ secrets.OPENAI_API_KEY }}" ] && echo "âœ… OPENAI_API_KEY is set" || echo "âŒ OPENAI_API_KEY is EMPTY"
          [ -n "${{ secrets.DATABASE_URL }}" ] && echo "âœ… DATABASE_URL is set" || echo "âŒ DATABASE_URL is EMPTY"
          [ -n "${{ secrets.WHATSAPP_API_URL }}" ] && echo "âœ… WHATSAPP_API_URL is set" || echo "âŒ WHATSAPP_API_URL is EMPTY"

      - name: Create .env file from secrets
        run: |
          cat > .env.deploy << EOF
          UISP_BASE_URL=${{ secrets.UISP_BASE_URL }}
          UISP_TOKEN=${{ secrets.UISP_TOKEN }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          LLM_MODEL=gpt-4o-mini
          LOG_LEVEL=INFO
          WHATSAPP_API_URL=${{ secrets.WHATSAPP_API_URL }}
          WHATSAPP_ENABLED=${{ secrets.WHATSAPP_ENABLED }}
          WHATSAPP_PHONE_COMPLETE=${{ secrets.WHATSAPP_PHONE_COMPLETE }}
          WHATSAPP_PHONE_SUMMARY=${{ secrets.WHATSAPP_PHONE_SUMMARY }}
          POLLING_ENABLED=${{ secrets.POLLING_ENABLED }}
          POLLING_INTERVAL_SECONDS=${{ secrets.POLLING_INTERVAL_SECONDS }}
          ALERT_OUTAGE_THRESHOLD_PERCENT=${{ secrets.ALERT_OUTAGE_THRESHOLD_PERCENT }}
          EOF

      - name: Debug - Verify .env.deploy content
        run: |
          echo "Checking .env.deploy file..."
          if [ -f ".env.deploy" ]; then
            echo "âœ… File exists"
            echo "File size: $(wc -c < .env.deploy) bytes"
            echo "Lines with values: $(grep -c '=' .env.deploy || echo 0)"
            echo "Empty lines: $(grep -c '^[A-Z_]*=$' .env.deploy || echo 0)"
          else
            echo "âŒ File does not exist"
          fi

      - name: Copy .env to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: "190.7.234.37"
          username: "root"
          password: "YmUeXJYrO3"
          port: 22
          source: ".env.deploy"
          target: "/opt/ubiquiti-llm/"

      - name: Setup VPS and Deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: "190.7.234.37"
          username: "root"
          password: "YmUeXJYrO3"
          port: 22
          command_timeout: 30m
          script: |
            echo "ğŸ”§ Verificando dependencias..."
            
            # Verificar Docker
            if ! command -v docker &> /dev/null; then
              echo "ğŸ“¦ Instalando Docker..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sh get-docker.sh
              rm get-docker.sh
            else
              echo "âœ… Docker ya estÃ¡ instalado"
            fi
            
            # Instalar Git si no existe
            if ! command -v git &> /dev/null; then
              echo "ğŸ“¦ Instalando Git..."
              apt update && apt install -y git curl
            else
              echo "âœ… Git ya estÃ¡ instalado"
            fi
            
            # Verificar versiones
            echo "ğŸ“‹ Versiones instaladas:"
            docker --version
            docker compose version
            git --version
            
            # Configurar directorio del proyecto
            PROJECT_DIR="/opt/ubiquiti-llm"
            
            # Crear directorio si no existe
            mkdir -p $PROJECT_DIR
            cd $PROJECT_DIR
            
            # Si el repo no existe, clonarlo
            if [ ! -d ".git" ]; then
              echo "ğŸ“¦ Clonando repositorio..."
              git clone https://github.com/rhernandezbas/ubiquiti__lmm.git .
            else
              echo "ğŸ”„ Actualizando repositorio..."
              git fetch origin
              git reset --hard origin/main
              git pull origin main
            fi
            
            # Usar archivo .env copiado desde GitHub Actions
            echo "ğŸ“ Usando archivo .env desde GitHub Actions..."
            if [ -f ".env.deploy" ]; then
              mv .env.deploy .env
              echo "âœ… Archivo .env configurado correctamente"
            else
              echo "âŒ Error: .env.deploy no encontrado"
              exit 1
            fi
            
            # Detener contenedores existentes
            echo "ğŸ›‘ Deteniendo contenedores..."
            docker compose down 2>/dev/null || true
            
            # Limpiar imÃ¡genes antiguas
            echo "ğŸ§¹ Limpiando imÃ¡genes antiguas..."
            docker image prune -af
            
            # Construir y levantar con los nuevos cambios
            echo "ğŸ—ï¸  Construyendo nueva imagen..."
            docker compose build --no-cache --pull
            
            echo "ğŸš€ Iniciando contenedores..."
            docker compose up -d
            
            # Esperar a que el contenedor estÃ© listo
            echo "â³ Esperando que el servicio estÃ© listo..."
            sleep 20
            
            # Mostrar estado
            echo "ğŸ“Š Estado de contenedores:"
            docker compose ps
            
            # Mostrar logs recientes
            echo "ğŸ“‹ Ãšltimos logs:"
            docker compose logs --tail=30
            
            echo "âœ… Despliegue completado exitosamente"

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: "190.7.234.37"
          username: "root"
          password: "YmUeXJYrO3"
          port: 22
          script: |
            cd /opt/ubiquiti-llm
            
            echo "ğŸ” Verificando estado del sistema..."
            
            # Verificar Docker
            if ! command -v docker &> /dev/null; then
              echo "âŒ Docker no estÃ¡ instalado"
              exit 1
            fi
            
            echo "âœ… Docker disponible: $(docker --version)"
            
            # Verificar si Docker estÃ¡ corriendo (sin sudo)
            if ! docker info &> /dev/null; then
              echo "âŒ Docker no estÃ¡ corriendo, intentando iniciar sin sudo..."
              # Intentar iniciar Docker sin sudo
              docker info &> /dev/null || {
                echo "âŒ No se puede iniciar Docker sin permisos"
                echo "ğŸ” Requiere acceso root o configuraciÃ³n de Docker"
                exit 1
              }
            fi
            
            echo "âœ… Docker corriendo"
            
            # Verificar contenedores
            echo "ğŸ“Š Verificando contenedores..."
            docker compose ps -a
            
            # Si no estÃ¡n corriendo, levantarlos
            if ! docker compose ps | grep -q "Up"; then
              echo "ğŸš€ Levantando contenedores..."
              docker compose up --build -d
              sleep 10
            fi
            
            # Verificar que estÃ©n corriendo
            if docker compose ps | grep -q "Up"; then
              echo "âœ… Contenedores corriendo correctamente"
              echo ""
              echo "ğŸ“Š Estado de servicios:"
              docker compose ps
              echo ""
              echo "ğŸŒ API disponible en: http://190.7.234.37:7657"
              echo "ğŸ“– DocumentaciÃ³n: http://190.7.234.37:7657/docs"
              echo "ğŸ¥ Health check: http://190.7.234.37:7657/health"
              echo ""
              echo "ğŸ“‹ Logs de la API:"
              docker compose logs --tail=10 api
              echo ""
              echo "ğŸ” Variables de entorno:"
              docker compose exec api env | grep -E "(ENCRYPTION_KEY|OPENAI_API_KEY)" || echo "Variables no encontradas"
            else
              echo "âŒ Error: Contenedores no estÃ¡n corriendo"
              echo ""
              echo "ğŸ“‹ Logs de error:"
              docker compose logs api
              echo ""
              echo "ğŸ” Intentando diagnÃ³stico:"
              docker compose ps -a
              echo ""
              echo "ğŸ“Š Estado del sistema:"
              df -h
              free -h
              docker system df
              exit 1
            fi
